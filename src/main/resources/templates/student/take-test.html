<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test</title>
  <link rel="stylesheet" th:href="@{/css/styles.css}"/>
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>

  <style>
    /* Reset and base styles with antique vibe */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Georgia', 'Times New Roman', serif; /* Vintage serif font */
    }

    body {
      background: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAKCAYAAACNMs+9AAAAJElEQVQIW2NkYGD4z0AswKYEhxQAAAABJRU5ErkJggg==') repeat; /* Parchment texture */
      background-color: #f4f7fa; /* Light gray background from previous designs */
      color: #7f8c8d; /* Muted gray for body text */
      line-height: 1.6;
    }

    /* Container with parchment effect */
    .container {
      max-width: 900px;
      margin: 50px auto;
      padding: 30px;
      background: linear-gradient(135deg, #ffffff, #f9fbfd); /* White to light gradient */
      border: 2px solid #2c3e50; /* Dark blue border */
      border-radius: 15px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2), inset 0 0 10px rgba(244, 247, 250, 0.5);
      position: relative;
      overflow: hidden;
    }

    /* Antique header with modern gradient */
    h1 {
      text-align: center;
      font-size: 2.5em;
      color: #2c3e50; /* Dark blue for headers */
      text-shadow: 2px 2px 4px rgba(44, 62, 80, 0.3);
      margin-bottom: 30px;
      padding-bottom: 10px;
      border-bottom: 3px double #2c3e50;
      background: linear-gradient(90deg, #6b48ff, #8e5cff); /* Purple gradient */
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }

    /* Alert styling with vintage paper effect */
    .alert-danger {
      background: #ffebee; /* Light red for errors */
      color: #c0392b; /* Dark red text */
      padding: 15px;
      margin-bottom: 20px;
      border: 1px dashed #c0392b;
      border-radius: 5px;
      text-align: center;
      font-style: italic;
    }

    /* Timer with ornate frame */
    .mb-3 {
      text-align: center;
      margin-bottom: 30px;
      padding: 15px;
      background: #ffffff;
      border: 2px solid #2c3e50;
      border-radius: 10px;
      box-shadow: inset 0 0 8px rgba(0, 0, 0, 0.1);
    }

    .mb-3 h2 {
      font-size: 1.5em;
      color: #34495e; /* Dark gray for emphasis */
    }

    #timer {
      font-weight: bold;
      color: #6b48ff; /* Purple for timer */
      text-transform: uppercase;
    }

    /* Card with antique-modern fusion */
    .card {
      background: #ffffff;
      padding: 20px;
      margin-bottom: 20px;
      border: 1px solid #2c3e50;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
    }

    .card h3 {
      font-size: 1.8em;
      color: #2c3e50;
      margin-bottom: 15px;
      text-decoration: underline;
      text-underline-offset: 5px;
    }

    .card p {
      font-size: 1.1em;
      color: #7f8c8d;
      margin: 10px 0;
    }

    /* Form elements with vintage-modern blend */
    form {
      margin-top: 20px;
    }

    label {
      display: block;
      font-size: 1.1em;
      color: #2c3e50;
      margin-bottom: 5px;
      font-weight: 600;
    }

    input[type="radio"] {
      margin-right: 10px;
      accent-color: #6b48ff; /* Purple for radio buttons */
    }

    textarea, input[type="radio"] + span {
      background: #ffffff;
      border: 1px solid #2c3e50;
      border-radius: 5px;
      padding: 10px;
      font-size: 1em;
      width: 100%;
      transition: border-color 0.3s ease;
    }

    textarea:focus, input[type="radio"]:focus + span {
      border-color: #6b48ff;
      outline: none;
      box-shadow: 0 0 5px rgba(107, 72, 255, 0.3);
    }

    textarea {
      height: 150px;
      resize: vertical;
    }

    /* Buttons with antique-modern fusion */
    button {
      display: inline-block;
      padding: 12px 25px;
      background: linear-gradient(90deg, #6b48ff, #8e5cff); /* Purple gradient */
      color: #ffffff;
      border: none;
      border-radius: 25px;
      font-size: 1em;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.3s ease, transform 0.2s ease;
      margin-right: 10px;
    }

    button:disabled {
      background: #bdc3c7; /* Light gray for disabled */
      cursor: not-allowed;
    }

    button:hover:not(:disabled) {
      background: linear-gradient(90deg, #5a3de6, #7d4aff); /* Darker purple gradient */
      transform: scale(1.05);
    }

    /* Debug info with subtle styling */
    .card p:last-child {
      font-size: 0.9em;
      color: #7f8c8d;
      font-style: italic;
      margin-top: 15px;
    }

    /* Responsive design */
    @media (max-width: 600px) {
      .container {
        margin: 20px;
        padding: 15px;
      }

      h1 {
        font-size: 1.8em;
      }

      .card {
        padding: 15px;
      }

      button {
        padding: 10px 20px;
        font-size: 0.9em;
      }

      textarea {
        height: 100px;
      }
    }
  </style>
</head>
<body>
<!-- Navbar -->
<div th:replace="~{frame/navbar :: navbar}"></div>

<div class="container">
  <h1 th:text="${studentTest != null and studentTest.test != null} ? ${studentTest.test.title} : 'Test'"></h1>

  <!-- Error Message -->
  <div th:if="${errorMessage != null}" class="alert-danger" th:text="${errorMessage}"></div>

  <!-- Timer -->
  <div class="mb-3">
    <h2>Time Remaining: <span id="timer"></span> seconds</h2>
  </div>

  <!-- Questions -->
  <div th:if="${questions != null and not #lists.isEmpty(questions)}">
    <div th:each="testQuestion, iterStat : ${questions}" th:if="${iterStat.index == currentQuestionIndex}" th:with="question=${testQuestion.question}">
      <div class="card">
        <h3 th:text="${question != null and question.title != null} ? ${question.title} : 'Question'"></h3>
        <p th:text="${question != null and question.questionText != null} ? ${question.questionText} : 'No question text'"></p>

   <!--     &lt;!&ndash; Debug Information &ndash;&gt;
        <p th:text="'Debug: Current Index: ' + ${currentQuestionIndex} +
                           ', TestQuestion ID: ' + ${testQuestion.id} +
                           ', Question ID: ' + ${question.id}"></p>-->

        <form th:action="@{/student/test/{studentTestId}/answer(studentTestId=${studentTest?.id})}" method="post">
          <input type="hidden" name="questionId" th:value="${question != null and question.id != null} ? ${question.id} : ''"/>
          <input type="hidden" name="currentQuestionIndex" th:value="${currentQuestionIndex}"/>

          <!-- Multiple Choice Question -->
          <div th:if="${question != null and question.getQuestionType() == 'MULTIPLE_CHOICE'}">
            <div th:if="${question.options != null and not #lists.isEmpty(question.options)}" th:each="option, optStat : ${question.options}">
              <label th:for="'option' + ${optStat.index}">
                <input type="radio" th:id="'option' + ${optStat.index}" name="response" th:value="${option}"/>
                <span th:text="${option != null} ? ${option} : 'No option'"></span>
              </label>
            </div>
            <div th:if="${question.options == null or #lists.isEmpty(question.options)}">
              <p>No options available for this question.</p>
            </div>
          </div>

          <!-- Descriptive Question -->
          <div th:if="${question != null and question.getQuestionType() == 'DESCRIPTION'}">
            <label for="response">Your Answer:</label>
            <textarea id="response" name="response" rows="4" cols="50" th:value="${existingAnswer != null} ? ${existingAnswer} : ''"></textarea>
          </div>

          <!-- Navigation Buttons -->
          <div>
            <button type="submit" name="action" value="previous" th:disabled="${currentQuestionIndex == 0}">
              <i class="fas fa-arrow-left"></i> Previous
            </button>
            <button type="submit" name="action" value="next" th:disabled="${currentQuestionIndex == #lists.size(questions) - 1}">
              Next <i class="fas fa-arrow-right"></i>
            </button>
            <button type="submit" name="action" value="submit">
              Submit <i class="fas fa-check"></i>
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
  <div th:if="${questions == null or #lists.isEmpty(questions)}">
    <p>No questions available for this test.</p>
  </div>
</div>

<script th:inline="javascript">
  let remainingTime = /*[[${studentTest != null} ? ${studentTest.remainingTime} : 0]]*/ 0;
  let studentTestId = /*[[${studentTest != null} ? ${studentTest.id} : 0]]*/ 0;
  let currentQuestionIndex = /*[[${currentQuestionIndex}]]*/ 0;
  let lastSavedResponse = '';

  function autoSave() {
    let response = $('textarea[name="response"]').val() || $('input[name="response"]:checked').val();
    let questionId = $('input[name="questionId"]').val();
    if (response !== lastSavedResponse && response !== undefined && questionId) {
      console.log('Auto-saving response: ' + response + ' for questionId: ' + questionId);
      $.post('/student/test/' + studentTestId + '/answer', {
        questionId: questionId,
        response: response,
        currentQuestionIndex: currentQuestionIndex,
        action: 'autosave'
      }).done(function() {
        lastSavedResponse = response;
        console.log('Auto-saved response: ' + response);
      }).fail(function(jqXHR, textStatus, errorThrown) {
        console.error('Auto-save failed: ' + textStatus + ', ' + errorThrown);
      });
    } else {
      console.log('No response to auto-save or missing questionId');
    }
  }

  function updateTimer() {
    if (remainingTime > 0) {
      remainingTime--;
      $('#timer').text(remainingTime);
      $.post('/student/test/' + studentTestId + '/time', { remainingTime: remainingTime })
              .done(function() { console.log('Time updated to: ' + remainingTime); })
              .fail(function() { console.log('Failed to update time'); });
      if (remainingTime % 30 === 0) autoSave();
    } else {
      $.post('/student/test/' + studentTestId + '/timeout')
              .done(function(response) {
                if (response.status === "submitted") {
                  window.location.href = '/student/dashboard';
                }
              })
              .fail(function() {
                window.location.href = '/student/dashboard';
              });
    }
  }

  $(document).ready(function() {
    $('#timer').text(remainingTime);
    if (remainingTime > 0) setInterval(updateTimer, 1000);
    autoSave();
    $('textarea[name="response"], input[name="response"]').on('change', function() {
      console.log('Input changed, triggering auto-save');
      autoSave();
    });
    $('form').on('submit', function(e) {
      let action = $(this).find('button[type="submit"]:focus').val();
      console.log('Form submitted with action: ' + action);
      if (action === 'submit') {
        console.log('Submitting test, triggering final auto-save');
        autoSave();
        setTimeout(function() {
          window.location.href = '/student/dashboard';
        }, 1000);
      }
    });
  });
</script>
</body>
</html>



<!--

<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test</title>
  <link rel="stylesheet" th:href="@{/css/styles.css}"/>
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>

  <style>
    /* Reset and base styles with antique vibe */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Georgia', 'Times New Roman', serif; /* Vintage serif font */
    }

    body {
      background: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAKCAYAAACNMs+9AAAAJElEQVQIW2NkYGD4z0AswKYEhxQAAAABJRU5ErkJggg==') repeat; /* Parchment texture */
      background-color: #f4f7fa; /* Light gray background from previous designs */
      color: #7f8c8d; /* Muted gray for body text */
      line-height: 1.6;
    }

    /* Container with parchment effect */
    .container {
      max-width: 900px;
      margin: 50px auto;
      padding: 30px;
      background: linear-gradient(135deg, #ffffff, #f9fbfd); /* White to light gradient */
      border: 2px solid #2c3e50; /* Dark blue border */
      border-radius: 15px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2), inset 0 0 10px rgba(244, 247, 250, 0.5);
      position: relative;
      overflow: hidden;
    }

    /* Antique header with modern gradient */
    h1 {
      text-align: center;
      font-size: 2.5em;
      color: #2c3e50; /* Dark blue for headers */
      text-shadow: 2px 2px 4px rgba(44, 62, 80, 0.3);
      margin-bottom: 30px;
      padding-bottom: 10px;
      border-bottom: 3px double #2c3e50;
      background: linear-gradient(90deg, #6b48ff, #8e5cff); /* Purple gradient */
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }

    /* Alert styling with vintage paper effect */
    .alert-danger {
      background: #ffebee; /* Light red for errors */
      color: #c0392b; /* Dark red text */
      padding: 15px;
      margin-bottom: 20px;
      border: 1px dashed #c0392b;
      border-radius: 5px;
      text-align: center;
      font-style: italic;
    }

    /* Timer with ornate frame */
    .mb-3 {
      text-align: center;
      margin-bottom: 30px;
      padding: 15px;
      background: #ffffff;
      border: 2px solid #2c3e50;
      border-radius: 10px;
      box-shadow: inset 0 0 8px rgba(0, 0, 0, 0.1);
    }

    .mb-3 h2 {
      font-size: 1.5em;
      color: #34495e; /* Dark gray for emphasis */
    }

    #timer {
      font-weight: bold;
      color: #6b48ff; /* Purple for timer */
      text-transform: uppercase;
    }

    /* Card with antique-modern fusion */
    .card {
      background: #ffffff;
      padding: 20px;
      margin-bottom: 20px;
      border: 1px solid #2c3e50;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
    }

    .card h3 {
      font-size: 1.8em;
      color: #2c3e50;
      margin-bottom: 15px;
      text-decoration: underline;
      text-underline-offset: 5px;
    }

    .card p {
      font-size: 1.1em;
      color: #7f8c8d;
      margin: 10px 0;
    }

    /* Form elements with vintage-modern blend */
    form {
      margin-top: 20px;
    }

    label {
      display: block;
      font-size: 1.1em;
      color: #2c3e50;
      margin-bottom: 5px;
      font-weight: 600;
    }

    input[type="radio"] {
      margin-right: 10px;
      accent-color: #6b48ff; /* Purple for radio buttons */
    }

    textarea, input[type="radio"] + span {
      background: #ffffff;
      border: 1px solid #2c3e50;
      border-radius: 5px;
      padding: 10px;
      font-size: 1em;
      width: 100%;
      transition: border-color 0.3s ease;
    }

    textarea:focus, input[type="radio"]:focus + span {
      border-color: #6b48ff;
      outline: none;
      box-shadow: 0 0 5px rgba(107, 72, 255, 0.3);
    }

    textarea {
      height: 150px;
      resize: vertical;
    }

    /* Buttons with antique-modern fusion */
    button {
      display: inline-block;
      padding: 12px 25px;
      background: linear-gradient(90deg, #6b48ff, #8e5cff); /* Purple gradient */
      color: #ffffff;
      border: none;
      border-radius: 25px;
      font-size: 1em;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.3s ease, transform 0.2s ease;
      margin-right: 10px;
    }

    button:disabled {
      background: #bdc3c7; /* Light gray for disabled */
      cursor: not-allowed;
    }

    button:hover:not(:disabled) {
      background: linear-gradient(90deg, #5a3de6, #7d4aff); /* Darker purple gradient */
      transform: scale(1.05);
    }

    /* Debug info with subtle styling */
    .card p:last-child {
      font-size: 0.9em;
      color: #7f8c8d;
      font-style: italic;
      margin-top: 15px;
    }

    /* Responsive design */
    @media (max-width: 600px) {
      .container {
        margin: 20px;
        padding: 15px;
      }

      h1 {
        font-size: 1.8em;
      }

      .card {
        padding: 15px;
      }

      button {
        padding: 10px 20px;
        font-size: 0.9em;
      }

      textarea {
        height: 100px;
      }
    }
  </style>
</head>
<body>
&lt;!&ndash; Navbar &ndash;&gt;
<div th:replace="~{frame/navbar :: navbar}"></div>

<div class="container">
  <h1 th:text="${studentTest != null and studentTest.test != null} ? ${studentTest.test.title} : 'Test'"></h1>

  &lt;!&ndash; Error Message &ndash;&gt;
  <div th:if="${errorMessage != null}" class="alert-danger" th:text="${errorMessage}"></div>

  &lt;!&ndash; Timer &ndash;&gt;
  <div class="mb-3">
    <h2>Time Remaining: <span id="timer"></span> seconds</h2>
  </div>

  &lt;!&ndash; Questions &ndash;&gt;
  <div th:if="${questions != null and not #lists.isEmpty(questions)}">
    <div th:each="testQuestion, iterStat : ${questions}" th:if="${iterStat.index == currentQuestionIndex}" th:with="question=${testQuestion.question}">
      <div class="card">
        <h3 th:text="${question != null and question.title != null} ? ${question.title} : 'Question'"></h3>
        <p th:text="${question != null and question.questionText != null} ? ${question.questionText} : 'No question text'"></p>

        &lt;!&ndash; Debug Information (optional) &ndash;&gt;
        &lt;!&ndash; <p th:text="'Debug: Current Index: ' + ${currentQuestionIndex} + ', TestQuestion ID: ' + ${testQuestion.id} + ', Question ID: ' + ${question.id}'"></p> &ndash;&gt;

        <form id="testForm" th:action="@{/student/test/{studentTestId}/answer(studentTestId=${studentTest?.id})}" method="post">
          <input type="hidden" name="questionId" th:value="${question != null and question.id != null} ? ${question.id} : ''"/>
          <input type="hidden" name="currentQuestionIndex" th:value="${currentQuestionIndex}"/>

          &lt;!&ndash; Multiple Choice Question &ndash;&gt;
          <div th:if="${question != null and question.getQuestionType() == 'MULTIPLE_CHOICE'}">
            <div th:if="${question.options != null and not #lists.isEmpty(question.options)}" th:each="option, optStat : ${question.options}">
              <label th:for="'option' + ${optStat.index}">
                <input type="radio" th:id="'option' + ${optStat.index}" name="response" th:value="${option}"/>
                <span th:text="${option != null} ? ${option} : 'No option'"></span>
              </label>
            </div>
            <div th:if="${question.options == null or #lists.isEmpty(question.options)}">
              <p>No options available for this question.</p>
            </div>
          </div>

          &lt;!&ndash; Descriptive Question &ndash;&gt;
          <div th:if="${question != null and question.getQuestionType() == 'DESCRIPTION'}">
            <label for="response">Your Answer:</label>
            <textarea id="response" name="response" rows="4" cols="50" th:value="${existingAnswer != null} ? ${existingAnswer} : ''"></textarea>
          </div>

          &lt;!&ndash; Navigation Buttons &ndash;&gt;
          <div>
            <button type="submit" name="action" value="previous" th:disabled="${currentQuestionIndex == 0}">
              <i class="fas fa-arrow-left"></i> Previous
            </button>
            <button type="submit" name="action" value="next" th:disabled="${currentQuestionIndex == #lists.size(questions) - 1}">
              Next <i class="fas fa-arrow-right"></i>
            </button>
            <button type="submit" name="action" value="submit">
              Submit <i class="fas fa-check"></i>
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
  <div th:if="${questions == null or #lists.isEmpty(questions)}">
    <p>No questions available for this test.</p>
  </div>
</div>


<script th:inline="javascript">
  let remainingTime = /*[[${studentTest != null} ? ${studentTest.remainingTime} : 0]]*/ 0;
  let studentTestId = /*[[${studentTest != null} ? ${studentTest.id} : 0]]*/ 0;
  let currentQuestionIndex = /*[[${currentQuestionIndex}]]*/ 0;
  let lastSavedResponse = '';
  const LOCAL_STORAGE_KEY = 'studentTestProgress_' + studentTestId;
  const totalQuestions = /*[[${#lists.size(questions)}]]*/ 0; // Total number of questions

  // Load saved state from localStorage
  function loadState() {
    const savedState = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY) || '{}');
    remainingTime = savedState.remainingTime || remainingTime;
    currentQuestionIndex = savedState.currentQuestionIndex || currentQuestionIndex;
    lastSavedResponse = savedState.lastSavedResponse || '';
    if (savedState.answers) {
      const questionId = $('input[name="questionId"]').val();
      if (questionId && savedState.answers[questionId]) {
        const response = savedState.answers[questionId];
        $('input[name="response"][value="' + response + '"]').prop('checked', true);
        $('textarea[name="response"]').val(response);
      }
    }
    return savedState.isOffline !== true && remainingTime > 0;
  }

  // Save state to localStorage
  function saveState(isOffline = false) {
    const state = {
      remainingTime,
      currentQuestionIndex,
      lastSavedResponse,
      answers: {},
      isOffline
    };
    const questionId = $('input[name="questionId"]').val();
    if (questionId) {
      const response = $('textarea[name="response"]').val() || $('input[name="response"]:checked').val();
      if (response) state.answers[questionId] = response;
    }
    localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(state));
  }

  function autoSave() {
    let response = $('textarea[name="response"]').val() || $('input[name="response"]:checked').val();
    let questionId = $('input[name="questionId"]').val();
    if (response !== lastSavedResponse && response !== undefined && questionId) {
      console.log('Auto-saving response: ' + response + ' for questionId: ' + questionId);
      if (navigator.onLine) {
        $.post('/student/test/' + studentTestId + '/answer', {
          questionId: questionId,
          response: response,
          currentQuestionIndex: currentQuestionIndex,
          action: 'autosave'
        }).done(function(data) {
          if (data.status === 'error') {
            console.error(data.message);
            window.location.href = '/student/dashboard';
            return;
          }
          lastSavedResponse = response;
          console.log('Auto-saved response: ' + response);
          saveState(false);
        }).fail(function(jqXHR, textStatus, errorThrown) {
          console.error('Auto-save failed, saving to localStorage: ' + textStatus + ', ' + errorThrown);
          saveState(true);
        });
      } else {
        console.log('Offline, saving to localStorage');
        saveState(true);
      }
    } else {
      console.log('No response to auto-save or missing questionId');
    }
  }

  function updateTimer() {
    if (remainingTime > 0) {
      remainingTime&#45;&#45;;
      $('#timer').text(remainingTime);
      if (navigator.onLine) {
        $.post('/student/test/' + studentTestId + '/time', { remainingTime: remainingTime })
                .done(function() { console.log('Time updated to: ' + remainingTime); })
                .fail(function() { console.log('Failed to update time, saving locally'); saveState(true); });
      } else {
        saveState(true);
      }
      if (remainingTime % 30 === 0) autoSave();
    } else {
      saveState(true);
      if (navigator.onLine) {
        $.post('/student/test/' + studentTestId + '/timeout')
                .done(function(response) {
                  if (response.status === "submitted") {
                    window.location.href = '/student/dashboard';
                  }
                })
                .fail(function() {
                  window.location.href = '/student/dashboard';
                });
      } else {
        window.location.href = '/student/dashboard';
      }
    }
  }

  function navigate(action) {
    console.log('Navigating with action: ' + action);
    let newIndex = currentQuestionIndex;
    if (action === 'previous' && currentQuestionIndex > 0) newIndex&#45;&#45;;
    else if (action === 'next' && currentQuestionIndex < totalQuestions - 1) newIndex++;
    if (newIndex !== currentQuestionIndex) {
      autoSave(); // Save current response
      currentQuestionIndex = newIndex;
      if (navigator.onLine) {
        $.post('/student/test/' + studentTestId + '/answer', {
          currentQuestionIndex: currentQuestionIndex,
          action: action
        }).done(function(data) {
          if (data.status === 'success') {
            console.log('Navigation successful, reloading page');
            window.location.href = '/student/test/' + studentTestId + '/start?index=' + currentQuestionIndex;
          } else {
            console.error('Navigation failed: ' + data.message);
          }
        }).fail(function() {
          console.error('Navigation failed, staying on current page');
        });
      } else {
        console.log('Offline, updating index locally');
        saveState(true);
        window.location.href = '/student/test/' + studentTestId + '/start?index=' + currentQuestionIndex;
      }
    }
  }

  function submitTest() {
    console.log('Submitting test');
    autoSave();
    setTimeout(function() {
      window.location.href = '/student/test/' + studentTestId + '/submit';
    }, 1000);
  }

  $(document).ready(function() {
    $('#timer').text(remainingTime);

    // Prevent continuation if time has expired or offline state loaded
    if (remainingTime <= 0 || !loadState()) {
      $('#testForm').hide();
      if (navigator.onLine) {
        $.post('/student/test/' + studentTestId + '/timeout')
                .done(function() { window.location.href = '/student/dashboard'; });
      } else {
        window.location.href = '/student/dashboard';
      }
      return;
    }

    // Start the timer
    if (remainingTime > 0) setInterval(updateTimer, 1000);

    // Initial auto-save
    autoSave();

    // Detect disconnection and reconnection
    window.addEventListener('offline', () => {
      console.log('Connection lost, saving to localStorage');
      saveState(true);
      $('#testForm').prop('disabled', true).find('input, textarea, button').prop('disabled', true);
    });

    window.addEventListener('online', () => {
      console.log('Connection restored, syncing with server');
      saveState(false);
      const questionId = $('input[name="questionId"]').val();
      const response = $('textarea[name="response"]').val() || $('input[name="response"]:checked').val();
      if (questionId && response) {
        $.post('/student/test/' + studentTestId + '/answer', {
          questionId: questionId,
          response: response,
          currentQuestionIndex: currentQuestionIndex,
          action: 'sync'
        }).done(function(data) {
          if (data.status === 'error') {
            console.error(data.message);
            window.location.href = '/student/dashboard';
            return;
          }
          $.post('/student/test/' + studentTestId + '/time', { remainingTime: remainingTime })
                  .done(function() {
                    console.log('Resumed test with remaining time: ' + remainingTime);
                    $('#testForm').prop('disabled', false).find('input, textarea, button').prop('disabled', false);
                  });
        }).fail(function() {
          console.error('Sync failed, redirecting to dashboard');
          window.location.href = '/student/dashboard';
        });
      }
    });

    // Auto-save on input change
    $('textarea[name="response"], input[name="response"]').on('change', function() {
      console.log('Input changed, triggering auto-save');
      autoSave();
    });

    // Handle button clicks directly
    $('button[name="action"]').on('click', function(e) {
      e.preventDefault();
      const action = $(this).val();
      console.log('Button clicked with action: ' + action);
      if (action === 'previous' || action === 'next') {
        navigate(action);
      } else if (action === 'submit') {
        submitTest();
      }
    });
  });
</script>
</body>
</html>

-->
